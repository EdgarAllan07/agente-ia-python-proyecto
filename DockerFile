# 1. Imagen Base: Usamos Python 3.11 (compatible con TensorFlow)
FROM python:3.11-slim

# 2. Instalar dependencias del sistema: Git y Git-LFS
# ¡Esto es lo más importante para descargar tu modelo .h5!
RUN apt-get update && apt-get install -y \
    git \
    git-lfs \
    && rm -rf /var/lib/apt/lists/*

# 3. Configurar Git LFS
RUN git lfs install

# 4. Establecer el directorio de trabajo en /app
WORKDIR /app

# 5. Copiar e instalar las librerías de Python
# (Se hace antes de copiar el código para usar el caché de Docker)
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip
RUN pip install --no-cache-dir -r requirements.txt

# 6. Copiar TODO tu proyecto (incluyendo los punteros .git y LFS)
COPY . .

# 7. ¡EL PASO CLAVE!
# Forzamos la descarga de los archivos LFS (tu .h5 y .joblib)
RUN git lfs pull

# 8. Exponer el puerto que Railway espera
ENV PORT=8080
EXPOSE 8080

# 9. Comando de inicio (reemplaza al Procfile)
# Le decimos a Gunicorn que se enlace al puerto que Railway le da
CMD ["gunicorn", "app:app", "--bind", "0.0.0.0:$PORT"]
